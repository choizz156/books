## 3. 외부 연동이 문제일 때 알아야 할 것들

### 3.1 타임아웃

- 타임아웃을 적절히 설정하지 않으면, 연동 서비스에 장애가 발생했을 경우 전체 서비스의 품질이 급격히 나빠짐.
- 연동 서비스에 대한 타임아웃을 설정하지 않으면, 연동 서비스의 응답이 느릴 때 처리량이 급격히 떨어짐.
- 만약 세 번째 100개 요청이 B 서비스 연동이 필요 없는 기능이라면 어떻게 될까?
    - B 서비스의 성능 문제가 다른 기능도 사용하지 못하게 만듦.
    - 새로 고침과 같은 방법으로 새로운 요청을 보낼 경우, 사용자 입장에서는 앞서 보낸 요청을 취소한 것이지만 A 서비스는 그 사실을 바로 인지하지 못함.
        - 그 전에 사용자가 보낸 요청을 여전히 처리 중.
> [!tldr]
> - 사용자는 타임아웃으로 지정한 시간 뒤에 에러 화면을 보게 됨.
> - 반응 없는 무한 대기보다는 에러 화면이라도 보는 것이 좋음.
> - 사용자 요청에 대해 자원이 포화되기 전에 응답하게 되므로, 연동 서비스 문제가 다른 기능에 주는 영향을 줄일 수 있음.

#### 3.1.1 연결 타임 아웃
- 네트워크 상황이나 연결할 서버의 상태에 따라 연결에 오랜 시간이 걸릴 수 있음.
    - 연결에 시간이 오래 걸리면 대기 시간도 함께 증가.
- 대기 시간이 무한정 길어지면 성능 문제가 발생하므로, `연결 타임아웃`을 설정해 연결 대기 시간을 제한해야 함.

#### 3.1.2 읽기 타임아웃
- 연결 후, 응답을 받기 까지 시간이 오래걸리면 대기 시간 문제가 발생.
- `읽기 타임 아웃`을 통해 응답 대기 시간을 제한해야 함.
> [!caution]
> - 읽기 타임아웃을 짧게 설정하면 타임아웃 에러가 자주 발생할 수 있음.
> - 연동 서비스가 정상 처리했음에도 불구하고 타임아웃 에러가 발생할 수 있음.
    > 	- 결제처럼 민감한 기능은 읽기 타임아웃 시간을 약간 길게 설정해서 간헐적으로 연동 시간이 길어지더라도 정상적으로 처리할 수 있어야 함.

### 3.2 재시도
- 외부 연동에 실패했을 때 처리 방법 중 하나는 재시도를 하는 것
    - 간헐적으로 연결에 실패하거나 일시적으로 응답이 느려지는 경우가 있음.
#### 3.2.1 재시도 가능 조건

1. 단순 조회 기능
2. 연결 타임 아웃
    - 연결 타임아웃이 발생했다는 것은 연동 서비스에 아직 연결이 되지 않았다는 것을 의미.
    - 연동 서비스가 요청을 처리하고 있지 않은 상태이므로, 네트워크 문제였다면 재시도를 통해 연결에 성공할 가능성이 있음.
3. 멱등성을 가진 변경 기능
    - 멱등성: 연산을 여러번 적용해도 결과가 달라지지 않은 성질
    - ex) '좋아요'를 한 번 눌렀다면 여러 번 눌러도 연산되지 않는 것

- 같은 api라도 실패 원인에 따라 재시도 여부를 결정해야함.
    - 검증 오류가 발생했다면 재시도를 해도 동일하게 실패할 가능성이 높음

#### 3.2.2 재시도 횟수와 간격
- 대부분의 경우 1 ~ 2번 정도의 재시도가 적당
- 모두 실패했다면 간헐적인 오류보다는 다른 근본적인 문제일 가능성이 높음.
- 일정 간격을 두고 재시도 해야함.
    - 재시도 간격을 점진적으로 늘리기도 함.

#### 3.2.3 재시도 폭풍
- 연동 서비스에는 더 큰 부하를 줄 수 있음.
- 재시도를 검토할 때는 연동 서비스의 성능 상황도 함께 고려해야 함.

### 3.3 동시 요청 제한
- 연동 서비스에 임계치 이상의 요청을 보내면서 발생하는 성능 저하 문제를 완화하는 방법은, 연동 서비스에 요청을 일정 수준 이상으로 보내지 않는 것.
> [!note]
> **벌크헤드**
> -  각 구성 요소를 격리함으로써 한 구성 요소의 장애가 다른 구성 요소에 영향을 주지 않도록 하는 설계 패턴
